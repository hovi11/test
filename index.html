<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --button-color: #007bff;
            --panel-color: #f0f0f0;
            --combo-color: #ff5722;
        }

        body.dark {
            --bg-color: #1e1e1e;
            --text-color: #ffffff;
            --button-color: #1a73e8;
            --panel-color: #2d2d2d;
            --combo-color: #ff7043;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 10px;
            transition: all 0.3s;
            user-select: none;
        }

        #click-area {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            background-image: url('https://q-xx.bstatic.com/xdata/images/hotel/max500/215500382.jpg?k=bfab20a750261abbb7ea08a9886b1eb9e0a7795acd9a3aefca9830a56cccf26b&s=100x100');
            background-size: cover;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--button-color);
            position: relative;
        }

        .stats {
            margin: 10px 0;
            font-size: 18px;
        }

        .nav {
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--panel-color);
            padding: 10px;
        }

        .nav-button {
            padding: 10px 15px;
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel-color);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            z-index: 100;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .upgrade {
            margin: 10px 0;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ddd;
        }

        .upgrade.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .close-button {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }

        .combo-display {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--combo-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .combo-bar {
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #FFC107, #F44336);
            margin-top: 5px;
            border-radius: 3px;
            display: none;
        }

        .critical-hit {
            animation: criticalAnimation 0.5s;
        }

        @keyframes criticalAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="stats">
        <div>Баланс: <span id="balance">0</span></div>
        <div>Урон за клик: <span id="damage-per-click">1</span></div>
        <div>Уровень: <span id="level">1</span> (<span id="current-damage">0</span>/<span id="required-damage">500</span>)</div>
        <div>Всего нанесено урона: <span id="total-damage">0</span></div>
    </div>

    <div id="click-area" onclick="clickDamage()">
        <div class="combo-display" id="combo-display">x1.0</div>
        <div class="combo-bar" id="combo-bar"></div>
    </div>

    <div class="nav">
        <button class="nav-button" onclick="openMenu('shop-menu')">Магазин</button>
        <button class="nav-button" onclick="openMenu('leaderboard-menu')">Таблица лидеров</button>
        <button class="nav-button" onclick="openMenu('boost-menu')">Усиления</button>
        <button class="nav-button" onclick="openMenu('achievements-menu')">Достижения</button>
    </div>

    <div id="shop-menu" class="menu">
        <span class="close-button" onclick="closeMenu('shop-menu')">×</span>
        <h2>Магазин</h2>
        <div id="upgrades-container"></div>
    </div>

    <div id="leaderboard-menu" class="menu">
        <span class="close-button" onclick="closeMenu('leaderboard-menu')">×</span>
        <h2>Таблица лидеров</h2>
        <div id="leaderboard-container">В разработке</div>
    </div>

    <div id="boost-menu" class="menu">
        <span class="close-button" onclick="closeMenu('boost-menu')">×</span>
        <h2>Усиления</h2>
        <div id="boosts-container"></div>
    </div>

    <div id="achievements-menu" class="menu">
        <span class="close-button" onclick="closeMenu('achievements-menu')">×</span>
        <h2>Достижения</h2>
        <div id="achievements-container"></div>
    </div>
    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark');
        }

        // Основные игровые переменные
        let balance = 0;
        let totalDamage = 0;
        let baseDamage = 1;
        let dps = 0;
        let level = 1;
        let experience = 0;
        let requiredExperience = 500;
        let combo = 1;
        let comboTimeout = null;
        let comboProgress = 0;
        let maxCombo = 3;
        let activeBoosts = [];
        let maxActiveBoosts = 2;
        let critChance = 0;
        let critMultiplier = 2;
        let autoClicker = 0;
        let globalMultiplier = 1;

        // Улучшения
        let upgrades = {
            // Ближний бой
            knife: { bought: false, cost: 50, damage: 1, type: 'melee' },
            axe: { bought: false, cost: 150, damage: 3, type: 'melee', requires: 'knife' },
            sword: { bought: false, cost: 300, damage: 5, type: 'melee', requires: 'axe' },
            chainsaw: { bought: false, cost: 700, damage: 10, type: 'melee', requires: 'sword' },
            lightsaber: { bought: false, cost: 1500, damage: 20, type: 'melee', requires: 'chainsaw' },
            
            // Дальний бой
            pistol: { bought: false, cost: 100, damage: 2, type: 'ranged' },
            rifle: { bought: false, cost: 250, damage: 5, type: 'ranged', requires: 'pistol' },
            sniper: { bought: false, cost: 600, damage: 12, type: 'ranged', requires: 'rifle', critChance: 5, critMultiplier: 3 },
            grenadeLauncher: { bought: false, cost: 1200, damage: 25, type: 'ranged', requires: 'sniper', aoe: true },
            plasmaGun: { bought: false, cost: 2500, damage: 50, type: 'ranged', requires: 'grenadeLauncher' },
            
            // Поддержка
            infantry: { bought: false, cost: 400, dps: 5, type: 'support' },
            artillery: { bought: false, cost: 1000, dps: 10, type: 'support', requires: 'infantry' }
        };

        // Усиления
        let boosts = {
            emperor: { 
                name: "За императора!", 
                description: "+2 урона за клик на 1 минуту", 
                cost: 0, 
                cooldown: 24 * 60 * 60 * 1000,
                effect: () => { baseDamage += 2; calculateDamage(); },
                revert: () => { baseDamage -= 2; calculateDamage(); },
                duration: 60000
            },
            mobilization: { 
                name: "Тотальная мобилизация", 
                description: "Удваивает DPS на 30 сек", 
                cost: 0, 
                cooldown: 60 * 60 * 1000,
                effect: () => { dps *= 2; },
                revert: () => { dps /= 2; },
                duration: 30000
            },
            reconnaissance: { 
                name: "Разведка", 
                description: "+50% урона на 20 кликов", 
                cost: 0, 
                cooldown: 45 * 60 * 1000,
                effect: () => { globalMultiplier *= 1.5; calculateDamage(); },
                revert: () => { globalMultiplier /= 1.5; calculateDamage(); },
                clicksLeft: 20,
                onClick: function(damage) {
                    this.clicksLeft--;
                    if (this.clicksLeft <= 0) {
                        this.revert();
                        activeBoosts = activeBoosts.filter(b => b.id !== 'reconnaissance');
                    }
                    return damage;
                }
            }
        };

        // Достижения (упрощенная версия)
        let achievements = {
            beginner: { 
                name: "Новичок", 
                description: "100 кликов", 
                achieved: false, 
                reward: "+1 базовый урон",
                condition: (stats) => stats.totalClicks >= 100,
                effect: () => { baseDamage += 1; calculateDamage(); }
            },
            sniperAch: { 
                name: "Снайпер", 
                description: "50 критических ударов", 
                achieved: false, 
                reward: "+5% шанс крита",
                condition: (stats) => stats.critHits >= 50,
                effect: () => { critChance += 5; }
            }
        };

        // Статистика
        let stats = {
            totalClicks: 0,
            critHits: 0,
            lastClickTime: 0
        };

        // Инициализация игры
        function initGame() {
            loadGame();
            startDPS();
            startAutoClicker();
            updateUI();
        }

        // Загрузка сохранения
        function loadGame() {
            const savedData = localStorage.getItem('warClickerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                balance = data.balance || 0;
                totalDamage = data.totalDamage || 0;
                baseDamage = data.baseDamage || 1;
                dps = data.dps || 0;
                level = data.level || 1;
                experience = data.experience || 0;
                requiredExperience = calculateRequiredExp(level);
                upgrades = data.upgrades || upgrades;
                boosts = data.boosts || boosts;
                achievements = data.achievements || achievements;
                stats = data.stats || stats;
                critChance = data.critChance || 0;
                critMultiplier = data.critMultiplier || 2;
                globalMultiplier = data.globalMultiplier || 1;
                maxActiveBoosts = data.maxActiveBoosts || 2;
                
                calculateDamage();
            }
        }

        // Сохранение игры
        function saveGame() {
            const gameData = {
                balance,
                totalDamage,
                baseDamage,
                dps,
                level,
                experience,
                upgrades,
                boosts,
                achievements,
                stats,
                critChance,
                critMultiplier,
                globalMultiplier,
                maxActiveBoosts
            };
            localStorage.setItem('warClickerData', JSON.stringify(gameData));
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify(gameData));
            }
        }

        // Расчет урона
        function calculateDamage() {
            damagePerClick = baseDamage;
            critChance = 0;
            
            // Применяем улучшения
            for (const [id, upgrade] of Object.entries(upgrades)) {
                if (upgrade.bought) {
                    if (upgrade.type === 'melee' || upgrade.type === 'ranged') {
                        damagePerClick += upgrade.damage;
                    }
                    if (upgrade.critChance) critChance += upgrade.critChance;
                    if (upgrade.critMultiplier) critMultiplier = Math.max(critMultiplier, upgrade.critMultiplier);
                }
            }
            
            // Применяем глобальный множитель
            damagePerClick = Math.floor(damagePerClick * globalMultiplier);
            
            // Расчет DPS
            dps = 0;
            if (upgrades.infantry.bought) dps += upgrades.infantry.dps;
            if (upgrades.artillery.bought) dps += upgrades.artillery.dps;
            dps = Math.floor(dps * globalMultiplier);
            
            // Автокликер
            if (autoClicker > 0) {
                dps += baseDamage * autoClicker;
            }
            
            updateUI();
        }

        // Клик по цели
        function clickDamage() {
            const now = Date.now();
            stats.totalClicks++;
            stats.lastClickTime = now;
            
            // Система комбо
            if (now - stats.lastClickTime < 2000) {
                combo = Math.min(maxCombo, combo + 0.1);
                showCombo();
            } else {
                combo = 1;
            }
            
            if (comboTimeout) clearTimeout(comboTimeout);
            comboTimeout = setTimeout(() => {
                combo = 1;
                document.getElementById('combo-display').style.opacity = '0';
                document.getElementById('combo-bar').style.display = 'none';
            }, 2000);
            
            // Расчет урона
            let damage = Math.floor(damagePerClick * combo);
            let isCritical = false;
            
            // Проверка на критический удар
            if (Math.random() * 100 < critChance) {
                damage *= critMultiplier;
                isCritical = true;
                stats.critHits++;
                document.getElementById('click-area').classList.add('critical-hit');
                setTimeout(() => {
                    document.getElementById('click-area').classList.remove('critical-hit');
                }, 500);
            }
            
            // Применение усилений
            activeBoosts.forEach(boost => {
                if (boosts[boost.id].onClick) {
                    damage = boosts[boost.id].onClick(damage);
                }
            });
            
            damage = Math.floor(damage);
            balance += damage;
            totalDamage += damage;
            experience += damage;
            
            // Проверка уровня
            checkLevelUp();
            
            // Обновление статистики
            stats.maxBalance = Math.max(stats.maxBalance, balance);
            
            updateUI();
            saveGame();
            checkAchievements();
        }

        // Показать комбо
        function showCombo() {
            const comboDisplay = document.getElementById('combo-display');
            const comboBar = document.getElementById('combo-bar');
            
            comboDisplay.textContent = `x${combo.toFixed(1)}`;
            comboDisplay.style.opacity = '1';
            comboBar.style.display = 'block';
            comboBar.style.width = `${(combo / maxCombo) * 100}%`;
        }

        // Проверка повышения уровня
        function checkLevelUp() {
            while (experience >= requiredExperience && level < 25) {
                experience -= requiredExperience;
                level++;
                requiredExperience = calculateRequiredExp(level);
                
                showNotification(`Уровень ${level} достигнут!`);
            }
        }

        // Расчет необходимого опыта для уровня
        function calculateRequiredExp(lvl) {
            return 500 * Math.pow(1.5, lvl - 1);
        }

        // Проверка достижений
        function checkAchievements() {
            for (const [id, achievement] of Object.entries(achievements)) {
                if (!achievement.achieved && achievement.condition(stats)) {
                    achievement.achieved = true;
                    if (achievement.effect) achievement
